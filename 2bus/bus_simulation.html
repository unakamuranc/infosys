<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2ビットバスシミュレーション - CPUと主記憶のデータ転送</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .simulation-area {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
            min-height: 500px;
        }

        .cpu-section {
            width: 300px;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            padding: 20px;
            background: #ecf0f1;
            position: relative;
        }

        .memory-section {
            width: 300px;
            border: 3px solid #2c3e50;
            border-radius: 10px;
            padding: 20px;
            background: #ecf0f1;
            position: relative;
        }

        .cpu-title, .memory-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 18px;
            color: #2c3e50;
        }

        .bus-area {
            width: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .address-bus, .data-bus {
            width: 100%;
            height: 80px;
            border: 2px solid #34495e;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            background: #bdc3c7;
        }

        .address-bus {
            background: #3498db;
            color: white;
        }

        .data-bus {
            background: #e74c3c;
            color: white;
        }

        .bus-label {
            position: absolute;
            top: -25px;
            left: 10px;
            font-weight: bold;
            font-size: 14px;
            color: #2c3e50;
        }

        .bit-display {
            display: flex;
            gap: 10px;
        }

        .bit {
            width: 40px;
            height: 40px;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            background: rgba(255,255,255,0.2);
        }

        .address-controls {
            margin-bottom: 20px;
        }

        .address-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .address-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: #3498db;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .address-btn:hover {
            background: #2980b9;
        }

        .address-btn.active {
            background: #e74c3c;
        }

        .memory-table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        .memory-table th, .memory-table td {
            border: 1px solid #34495e;
            padding: 8px;
            text-align: center;
        }

        .memory-table th {
            background: #34495e;
            color: white;
        }

        .memory-table td {
            background: white;
        }

        .memory-table tr.selected {
            background: #f39c12 !important;
        }

        .memory-table td.data {
            background: #ecf0f1;
        }

        .data-input {
            width: 30px;
            height: 30px;
            border: 1px solid #bdc3c7;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
        }

        .cpu-display {
            text-align: center;
            margin: 15px 0;
        }

        .cpu-speech {
            background: white;
            border: 2px solid #3498db;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            font-size: 14px;
        }

        .cpu-speech::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #3498db;
        }

        .memory-speech {
            background: white;
            border: 2px solid #e74c3c;
            border-radius: 20px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
            font-size: 14px;
        }

        .memory-speech::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid #e74c3c;
        }

        .character {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f39c12;
            margin: 10px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .controls {
            text-align: center;
            margin-top: 20px;
        }

        .control-btn {
            padding: 12px 25px;
            margin: 5px;
            border: none;
            border-radius: 8px;
            background: #27ae60;
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .control-btn:hover {
            background: #2ecc71;
        }

        .info-panel {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .info-title {
            font-weight: bold;
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }

        .status {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin: 15px 0;
            padding: 10px;
            border-radius: 5px;
        }

        .status.read {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.write {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Register Styles */
        .register-section {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .register-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #856404;
        }

        .register-display {
            display: flex;
            justify-content: center;
            margin: 10px 0;
        }

        .register-bit {
            background: #ffc107 !important;
            color: #212529 !important;
            border-color: #856404 !important;
        }

        .register-controls {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 10px;
        }

        .register-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: #ffc107;
            color: #212529;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .register-btn:hover {
            background: #ffca2c;
        }

        /* Input Device Styles */
        .input-device {
            background: #d1ecf1;
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .input-device-title {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #0c5460;
        }

        .input-device-content {
            text-align: center;
        }

        .input-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .input-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            background: #17a2b8;
            color: white;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .input-btn:hover {
            background: #138496;
        }

        .input-btn.active {
            background: #dc3545;
        }

        .input-status {
            font-size: 14px;
            margin-top: 10px;
            color: #0c5460;
        }

        /* I/O Row Styles */
        .io-row {
            background: #d1ecf1 !important;
        }

        .io-data {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: bold;
            color: #0c5460;
        }

        .io-indicator {
            font-size: 16px;
        }

        /* Animation for register operations */
        .register-highlight {
            animation: registerPulse 0.8s;
        }

        @keyframes registerPulse {
            0% { background: #fff3cd; }
            50% { background: #ffd700; }
            100% { background: #fff3cd; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>2ビットバスシミュレーション - CPUと主記憶のデータ転送</h1>
        
        <div class="simulation-area">
            <!-- CPU Section -->
            <div class="cpu-section">
                <div class="cpu-title">CPU</div>
                <div class="character">👩‍💻</div>
                <div class="cpu-speech" id="cpuSpeech">
                    アドレス00のデータを読み取りたい！
                </div>
                
                <!-- CPU Register -->
                <div class="register-section">
                    <div class="register-title">レジスタA</div>
                    <div class="register-display">
                        <div class="bit-display" id="cpuRegister">
                            <div class="bit register-bit">0</div>
                            <div class="bit register-bit">0</div>
                        </div>
                    </div>
                    <div class="register-controls">
                        <button class="register-btn" onclick="loadFromRegister()">REG→データバス</button>
                        <button class="register-btn" onclick="storeToRegister()">データバス→REG</button>
                    </div>
                </div>
                
                <div class="cpu-display">
                    <strong>現在の操作:</strong>
                    <div id="currentOperation">待機中</div>
                </div>
            </div>

            <!-- Bus Area -->
            <div class="bus-area">
                <div class="address-bus">
                    <div class="bus-label">アドレスバス</div>
                    <div class="bit-display" id="addressBus">
                        <div class="bit">0</div>
                        <div class="bit">0</div>
                    </div>
                </div>
                
                <div class="address-controls">
                    <div><strong>アドレス選択:</strong></div>
                    <div class="address-buttons">
                        <button class="address-btn active" onclick="setAddress(0)">00</button>
                        <button class="address-btn" onclick="setAddress(1)">01</button>
                        <button class="address-btn" onclick="setAddress(2)">10</button>
                        <button class="address-btn" onclick="setAddress(3)">11</button>
                    </div>
                </div>

                <div class="data-bus">
                    <div class="bus-label">データバス</div>
                    <div class="bit-display" id="dataBus">
                        <div class="bit">1</div>
                        <div class="bit">0</div>
                    </div>
                </div>

                <div class="status" id="operationStatus">
                    読み取りモード
                </div>
            </div>

            <!-- Memory Section -->
            <div class="memory-section">
                <div class="memory-title">主記憶</div>
                <div class="character">👨‍💼</div>
                <div class="memory-speech" id="memorySpeech">
                    アドレス00のデータを送ります！
                </div>
                
                <table class="memory-table">
                    <thead>
                        <tr>
                            <th>アドレス</th>
                            <th>データ</th>
                        </tr>
                    </thead>
                    <tbody id="memoryTable">
                        <tr class="selected">
                            <td>00</td>
                            <td class="data">
                                <input type="text" class="data-input" maxlength="1" value="1" onchange="updateMemoryData(0, 0, this.value)">
                                <input type="text" class="data-input" maxlength="1" value="0" onchange="updateMemoryData(0, 1, this.value)">
                            </td>
                        </tr>
                        <tr>
                            <td>01</td>
                            <td class="data">
                                <input type="text" class="data-input" maxlength="1" value="0" onchange="updateMemoryData(1, 0, this.value)">
                                <input type="text" class="data-input" maxlength="1" value="1" onchange="updateMemoryData(1, 1, this.value)">
                            </td>
                        </tr>
                        <tr>
                            <td>10</td>
                            <td class="data">
                                <input type="text" class="data-input" maxlength="1" value="1" onchange="updateMemoryData(2, 0, this.value)">
                                <input type="text" class="data-input" maxlength="1" value="1" onchange="updateMemoryData(2, 1, this.value)">
                            </td>
                        </tr>
                        <tr class="io-row">
                            <td>11</td>
                            <td class="data io-data">
                                <span id="ioDataDisplay">00</span>
                                <div class="io-indicator">📡</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                
                <!-- External Input Device -->
                <div class="input-device">
                    <div class="input-device-title">📱 外部入力装置</div>
                    <div class="input-device-content">
                        <div class="input-buttons">
                            <button class="input-btn" onclick="setExternalInput(0)">00</button>
                            <button class="input-btn" onclick="setExternalInput(1)">01</button>
                            <button class="input-btn" onclick="setExternalInput(2)">10</button>
                            <button class="input-btn" onclick="setExternalInput(3)">11</button>
                        </div>
                        <div class="input-status">
                            現在の入力値: <span id="inputValue">00</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="performRead()">📖 データ読み取り</button>
            <button class="control-btn" onclick="performWrite()">✏️ データ書き込み</button>
            <button class="control-btn" onclick="resetSimulation()">🔄 リセット</button>
        </div>

        <div class="info-panel">
            <div class="info-title">📚 使い方</div>
            <p><strong>1. アドレス選択:</strong> アドレスバス下のボタン（00, 01, 10, 11）でアクセス先を指定</p>
            <p><strong>2. データ読み取り:</strong> 「データ読み取り」ボタンで、メモリ→データバス→レジスタに自動格納</p>
            <p><strong>3. データ書き込み:</strong> 「データ書き込み」ボタンで、レジスタ→データバス→メモリに書き込み</p>
            <p><strong>4. レジスタ操作:</strong> 「REG→データバス」「データバス→REG」で手動レジスタ操作</p>
            <p><strong>5. 外部入力:</strong> 入力装置の00/01/10/11ボタンでアドレス11の値を設定</p>
            <p><strong>6. データ編集:</strong> 主記憶テーブル（00-10）の入力欄で直接0/1を変更可能</p>
        </div>
    </div>

    <script>
        let currentAddress = 0;
        let memory = [
            [1, 0],  // Address 00: 10
            [0, 1],  // Address 01: 01
            [1, 1],  // Address 10: 11
            [0, 0]   // Address 11: 00 (I/O port)
        ];
        let isWriteMode = false;
        let cpuRegister = [0, 0];  // CPU Register A
        let externalInput = 0;     // External input value (0-3)

        function setAddress(address) {
            currentAddress = address;
            
            // Update address bus display
            const addressBits = address.toString(2).padStart(2, '0');
            const addressBusElements = document.querySelectorAll('#addressBus .bit');
            addressBusElements[0].textContent = addressBits[0];
            addressBusElements[1].textContent = addressBits[1];
            
            // Update button states
            document.querySelectorAll('.address-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === address);
            });
            
            // Update memory table selection
            document.querySelectorAll('#memoryTable tr').forEach((row, index) => {
                row.classList.toggle('selected', index === address);
            });
            
            // Update displays
            updateCPUSpeech();
            updateMemorySpeech();
            
            // Update data bus if in read mode
            if (!isWriteMode) {
                updateDataBus();
            }
        }

        function updateDataBus() {
            const dataBusElements = document.querySelectorAll('#dataBus .bit');
            
            // If address 11 (I/O), get data from external input
            if (currentAddress === 3) {
                const inputBinary = externalInput.toString(2).padStart(2, '0');
                dataBusElements[0].textContent = inputBinary[0];
                dataBusElements[1].textContent = inputBinary[1];
                // Also update memory display
                memory[3][0] = parseInt(inputBinary[0]);
                memory[3][1] = parseInt(inputBinary[1]);
                updateIODisplay();
            } else {
                dataBusElements[0].textContent = memory[currentAddress][0];
                dataBusElements[1].textContent = memory[currentAddress][1];
            }
        }

        function updateCPURegister() {
            const registerElements = document.querySelectorAll('#cpuRegister .bit');
            registerElements[0].textContent = cpuRegister[0];
            registerElements[1].textContent = cpuRegister[1];
        }

        function updateIODisplay() {
            const ioDisplay = document.getElementById('ioDataDisplay');
            const inputBinary = externalInput.toString(2).padStart(2, '0');
            ioDisplay.textContent = inputBinary;
        }

        function updateCPUSpeech() {
            const addressBinary = currentAddress.toString(2).padStart(2, '0');
            const cpuSpeech = document.getElementById('cpuSpeech');
            
            if (isWriteMode) {
                cpuSpeech.textContent = `アドレス${addressBinary}にデータを書き込みます！`;
            } else {
                cpuSpeech.textContent = `アドレス${addressBinary}のデータを読み取りたい！`;
            }
        }

        function updateMemorySpeech() {
            const addressBinary = currentAddress.toString(2).padStart(2, '0');
            const dataBinary = memory[currentAddress].join('');
            const memorySpeech = document.getElementById('memorySpeech');
            
            if (isWriteMode) {
                memorySpeech.textContent = `アドレス${addressBinary}にデータを受け取ります！`;
            } else {
                memorySpeech.textContent = `アドレス${addressBinary}のデータ${dataBinary}を送ります！`;
            }
        }

        function performRead() {
            isWriteMode = false;
            updateDataBus();
            
            // Automatically load to register after read
            setTimeout(() => {
                storeToRegister();
            }, 500);
            
            const addressName = currentAddress === 3 ? '外部入力装置' : `アドレス${currentAddress.toString(2).padStart(2, '0')}`;
            document.getElementById('currentOperation').textContent = `${addressName}からデータ読み取り→レジスタに格納`;
            document.getElementById('operationStatus').className = 'status read';
            document.getElementById('operationStatus').textContent = '読み取りモード';
            
            updateCPUSpeech();
            updateMemorySpeech();
            
            // Animation effect
            const dataBus = document.querySelector('.data-bus');
            dataBus.style.animation = 'pulse 0.5s';
            setTimeout(() => {
                dataBus.style.animation = '';
            }, 500);
        }

        function performWrite() {
            isWriteMode = true;
            
            // First load register data to data bus
            loadFromRegister();
            
            setTimeout(() => {
                // Get current data from data bus (now containing register data)
                const dataBusElements = document.querySelectorAll('#dataBus .bit');
                
                // Don't write to address 11 (I/O port is read-only)
                if (currentAddress === 3) {
                    document.getElementById('currentOperation').textContent = 'エラー: 外部入力装置は読み取り専用です';
                    return;
                }
                
                memory[currentAddress][0] = parseInt(dataBusElements[0].textContent);
                memory[currentAddress][1] = parseInt(dataBusElements[1].textContent);
                
                // Update memory table inputs
                const memoryInputs = document.querySelectorAll(`#memoryTable tr:nth-child(${currentAddress + 1}) .data-input`);
                memoryInputs[0].value = memory[currentAddress][0];
                memoryInputs[1].value = memory[currentAddress][1];
                
                document.getElementById('currentOperation').textContent = `レジスタ→アドレス${currentAddress.toString(2).padStart(2, '0')}に書き込み完了！`;
                document.getElementById('operationStatus').className = 'status write';
                document.getElementById('operationStatus').textContent = '書き込みモード';
                
                updateCPUSpeech();
                updateMemorySpeech();
                
                // Animation effect
                const addressBus = document.querySelector('.address-bus');
                addressBus.style.animation = 'pulse 0.5s';
                setTimeout(() => {
                    addressBus.style.animation = '';
                    isWriteMode = false;
                    document.getElementById('operationStatus').className = 'status read';
                    document.getElementById('operationStatus').textContent = '読み取りモード';
                    updateCPUSpeech();
                    updateMemorySpeech();
                }, 1000);
            }, 300);
        }

        function updateMemoryData(address, bitIndex, value) {
            // Validate input (only 0 or 1)
            if (value !== '0' && value !== '1') {
                value = '0';
                event.target.value = '0';
            }
            
            memory[address][bitIndex] = parseInt(value);
            
            // Update data bus if current address matches
            if (address === currentAddress && !isWriteMode) {
                updateDataBus();
            }
            
            updateMemorySpeech();
        }

        function loadFromRegister() {
            // Load register data to data bus
            const dataBusElements = document.querySelectorAll('#dataBus .bit');
            dataBusElements[0].textContent = cpuRegister[0];
            dataBusElements[1].textContent = cpuRegister[1];
            
            document.getElementById('currentOperation').textContent = 'レジスタ→データバス';
            
            // Animation
            const registerSection = document.querySelector('.register-section');
            registerSection.classList.add('register-highlight');
            setTimeout(() => {
                registerSection.classList.remove('register-highlight');
            }, 800);
        }

        function storeToRegister() {
            // Store data bus content to register
            const dataBusElements = document.querySelectorAll('#dataBus .bit');
            cpuRegister[0] = parseInt(dataBusElements[0].textContent);
            cpuRegister[1] = parseInt(dataBusElements[1].textContent);
            
            updateCPURegister();
            document.getElementById('currentOperation').textContent = 'データバス→レジスタ';
            
            // Animation
            const registerSection = document.querySelector('.register-section');
            registerSection.classList.add('register-highlight');
            setTimeout(() => {
                registerSection.classList.remove('register-highlight');
            }, 800);
        }

        function setExternalInput(value) {
            externalInput = value;
            
            // Update button states
            document.querySelectorAll('.input-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === value);
            });
            
            // Update display
            document.getElementById('inputValue').textContent = value.toString(2).padStart(2, '0');
            updateIODisplay();
            
            // If currently reading from address 11, update data bus
            if (currentAddress === 3 && !isWriteMode) {
                updateDataBus();
            }
        }

        function resetSimulation() {
            currentAddress = 0;
            memory = [
                [1, 0],  // Address 00: 10
                [0, 1],  // Address 01: 01
                [1, 1],  // Address 10: 11
                [0, 0]   // Address 11: 00
            ];
            isWriteMode = false;
            cpuRegister = [0, 0];
            externalInput = 0;
            
            // Reset all inputs
            const inputs = document.querySelectorAll('.data-input');
            inputs.forEach((input, index) => {
                const address = Math.floor(index / 2);
                const bitIndex = index % 2;
                input.value = memory[address][bitIndex];
            });
            
            // Reset external input buttons
            document.querySelectorAll('.input-btn').forEach((btn, index) => {
                btn.classList.toggle('active', index === 0);
            });
            document.getElementById('inputValue').textContent = '00';
            
            // Reset to address 00
            setAddress(0);
            
            document.getElementById('currentOperation').textContent = '待機中';
            document.getElementById('operationStatus').className = 'status read';
            document.getElementById('operationStatus').textContent = '読み取りモード';
            
            updateCPURegister();
            updateIODisplay();
            updateDataBus();
        }

        // Add CSS animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }
        `;
        document.head.appendChild(style);

        // Initialize
        setAddress(0);
        updateCPURegister();
        updateIODisplay();
        setExternalInput(0);
        updateDataBus();
    </script>
</body>
</html>