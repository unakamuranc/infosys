<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N進法と10進法の相互変換</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background-color: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { color: #333; text-align: center; }
        .controls { display: flex; justify-content: center; gap: 20px; margin: 20px 0; flex-wrap: wrap; }
        .control-group { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        input, button { padding: 10px; font-size: 16px; border: 2px solid #ddd; border-radius: 5px; }
        button { background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        .converter-section { margin: 30px 0; padding: 20px; border: 2px solid #e0e0e0; border-radius: 10px; background-color: #fafafa; }
        .visualization { margin: 20px 0; padding: 20px; background-color: white; border-radius: 5px; min-height: 200px; }
        .step-info { margin: 10px 0; padding: 10px; background-color: #e8f5e8; border-left: 4px solid #4CAF50; font-size: 14px; }
        .result { font-size: 18px; font-weight: bold; color: #333; text-align: center; margin: 15px 0; padding: 15px; background-color: #f0f8ff; border: 2px solid #4CAF50; border-radius: 8px; }
        .error { color: #f44336; background-color: #ffebee; border-color: #f44336; }
        .tab-container { margin: 20px 0; }
        .tab-buttons { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab-button { background-color: #f5f5f5; border: none; padding: 15px 30px; font-size: 16px; color: #333; cursor: pointer; border-radius: 8px 8px 0 0; margin-right: 5px; }
        .tab-button.active { background-color: white; font-weight: bold; border-top: 2px solid #4CAF50; }
        .tab-button:hover:not(.active) { background-color: #e8f5e8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .unit { display: inline-block; width: 20px; height: 20px; background-color: #4CAF50; margin: 2px; border-radius: 3px; }
        .group {
            display: inline-block;
            margin: 5px;
            padding: 10px;
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
            vertical-align: top;
        }
        .big-box {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            border: 3px solid;
            border-radius: 12px;
            vertical-align: top;
            position: relative;
        }
        .big-box-label {
            position: absolute;
            top: -12px;
            left: 10px;
            background-color: white;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: bold;
            border-radius: 4px;
        }
        .small-boxes-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>N進法と10進法の相互変換</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="radix">進法 (N):</label>
                <input type="number" id="radix" min="2" max="16" value="2" />
            </div>
            <div class="control-group">
                <label for="decimalInput">10進数 (k):</label>
                <input type="number" id="decimalInput" min="0" max="1000" value="13" />
            </div>
            <div class="control-group">
                <label for="radixInput">N進数:</label>
                <input type="text" id="radixInput" placeholder="例: 1101" />
            </div>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="switchTab('decimal-to-radix')">10進法 → N進法への変換</button>
                <button class="tab-button" onclick="switchTab('radix-to-decimal')">N進法 → 10進法への変換</button>
            </div>

            <div id="decimal-to-radix" class="tab-content active converter-section">
                <button onclick="convertDecimalToRadix()">10進数をN進数に変換</button>
                <div id="decimal-to-radix-steps"></div>
                <div id="decimal-to-radix-visualization" class="visualization"></div>
                <div id="decimal-to-radix-result"></div>
            </div>

            <div id="radix-to-decimal" class="tab-content converter-section">
                <button onclick="convertRadixToDecimal()">N進数を10進数に変換</button>
                <div id="radix-to-decimal-steps"></div>
                <div id="radix-to-decimal-visualization" class="visualization"></div>
                <div id="radix-to-decimal-result"></div>
            </div>
        </div>
    </div>

    <script>
        function convertDecimalToRadix() {
            const radix = parseInt(document.getElementById('radix').value);
            const decimal = parseInt(document.getElementById('decimalInput').value);
            
            if (radix < 2 || radix > 16) {
                showError('decimal-to-radix-result', 'Nは2から16の間で指定してください');
                return;
            }
            
            if (decimal < 0) {
                showError('decimal-to-radix-result', '正の整数を入力してください');
                return;
            }

            visualizeDecimalToRadix(decimal, radix);
        }

        function convertRadixToDecimal() {
            const radix = parseInt(document.getElementById('radix').value);
            const radixStr = document.getElementById('radixInput').value.trim();
            
            if (radix < 2 || radix > 16) {
                showError('radix-to-decimal-result', 'Nは2から16の間で指定してください');
                return;
            }
            
            if (!radixStr) {
                showError('radix-to-decimal-result', 'N進数を入力してください');
                return;
            }

            const validChars = '0123456789ABCDEF'.slice(0, radix);
            for (let char of radixStr.toUpperCase()) {
                if (!validChars.includes(char)) {
                    showError('radix-to-decimal-result', radix + '進法では使用できない文字が含まれています: ' + char);
                    return;
                }
            }

            visualizeRadixToDecimal(radixStr.toUpperCase(), radix);
        }

        function visualizeDecimalToRadix(decimal, radix) {
            const stepsDiv = document.getElementById('decimal-to-radix-steps');
            const visualDiv = document.getElementById('decimal-to-radix-visualization');
            const resultDiv = document.getElementById('decimal-to-radix-result');
            
            stepsDiv.innerHTML = '';
            visualDiv.innerHTML = '';
            
            // ステップ1: 個別の物を表示
            let stepHtml = '<div class="step-info">ステップ1: ' + decimal + '個の物を表現</div>';
            stepsDiv.innerHTML = stepHtml;
            
            // 単位を描画
            let unitsHtml = '<div>物: ';
            const maxUnitsToShow = 50; // 表示制限
            for (let i = 0; i < Math.min(decimal, maxUnitsToShow); i++) {
                unitsHtml += '<span class="unit"></span>';
            }
            if (decimal > maxUnitsToShow) {
                unitsHtml += ' <span>... (合計' + decimal + '個)</span>';
            }
            unitsHtml += '</div><p>合計: ' + decimal + '個</p>';
            visualDiv.innerHTML = unitsHtml;
            
            setTimeout(() => {
                visualizeHierarchicalBoxing(decimal, radix, 0, stepHtml, unitsHtml, stepsDiv, visualDiv, resultDiv);
            }, 1000);
        }

        function visualizeHierarchicalBoxing(remaining, radix, level, stepHtml, previousHtml, stepsDiv, visualDiv, resultDiv) {
            const boxSize = Math.pow(radix, level + 1);
            const boxCount = Math.floor(remaining / boxSize);
            const remainder = remaining % boxSize;
            
            const currentBoxSize = Math.pow(radix, level + 1);
            const currentLevelName = 'サイズ' + currentBoxSize;
            
            stepHtml += '<div class="step-info">ステップ' + (level + 2) + ': ' + currentLevelName + 'の箱に' + radix + '箱ずつ詰める</div>';
            stepsDiv.innerHTML = stepHtml;
            
            let currentHtml = '<div style="margin: 15px 0; padding: 10px; background-color: #f0f8ff; border-left: 4px solid #2196f3;">';
            currentHtml += '<strong>' + currentLevelName + 'の箱作り:</strong><br>';
            
            if (level === 0) {
                // レベル0: 個別の物をサイズ1の箱（N個入り）に詰める
                currentHtml += remaining + '個の物を' + radix + '個ずつ箱に詰める → サイズ' + radix + 'の箱が' + boxCount + '箱できる, 余り' + remainder + '個　　' + remaining + '÷' + radix + ' = ' + boxCount + ' 余り ' + remainder + '<br>';
                
                // 箱と余りを横並びで表示
                currentHtml += '<div style="margin: 15px 0; display: flex; gap: 20px; align-items: flex-start;">';
                
                // サイズNの箱を表示
                currentHtml += '<div style="flex: 1; padding: 10px; background-color: #e8f5e8; border-left: 4px solid #4CAF50; border-radius: 5px;">';
                if (boxCount > 0) {
                    currentHtml += '<div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">作られた箱（サイズ' + radix + '）</div>';
                    currentHtml += '<div style="display: flex; flex-wrap: wrap; gap: 5px;">';
                    for (let i = 0; i < Math.min(boxCount, 10); i++) {
                        currentHtml += '<div class="group" style="background-color: #e1f5fe; border-color: #01579b;">サイズ' + radix + '</div>';
                    }
                    if (boxCount > 10) {
                        currentHtml += ' <div style="margin: 10px; font-weight: bold; align-self: center;">... (合計' + boxCount + '箱)</div>';
                    }
                    currentHtml += '</div>';
                } else {
                    currentHtml += '<div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">作られた箱（サイズ' + radix + '）</div>';
                    currentHtml += '<div style="color: #666; font-style: italic;">箱は作られませんでした</div>';
                }
                currentHtml += '</div>';
                
                // 余りの個別の物を表示（常に表示）
                currentHtml += '<div style="flex: 1; padding: 10px; background-color: #fff3e0; border-left: 4px solid #ff9800; border-radius: 5px;">';
                currentHtml += '<div style="font-size: 14px; font-weight: bold; margin-bottom: 10px;">余った物</div>';
                if (remainder > 0) {
                    currentHtml += '<div style="display: flex; flex-wrap: wrap; gap: 3px;">';
                    for (let i = 0; i < Math.min(remainder, 15); i++) {
                        currentHtml += '<span class="unit"></span>';
                    }
                    if (remainder > 15) {
                        currentHtml += ' <div style="margin: 5px; font-size: 12px;">... (合計' + remainder + '個)</div>';
                    } else {
                        currentHtml += ' <div style="margin: 5px; font-size: 12px;">(' + remainder + '個)</div>';
                    }
                    currentHtml += '</div>';
                } else {
                    currentHtml += '<div style="color: #666; font-style: italic;">余りはありません</div>';
                }
                currentHtml += '</div>';
                
                currentHtml += '</div>';
            }
            
            currentHtml += '</div>';
            
            visualDiv.innerHTML = previousHtml + currentHtml;
            
            // 次のレベルに進むかチェック
            if (boxCount >= radix && level < 5) {
                setTimeout(() => {
                    visualizeHierarchicalBoxing(remaining, radix, level + 1, stepHtml, previousHtml + currentHtml, stepsDiv, visualDiv, resultDiv);
                }, 1500);
            } else {
                setTimeout(() => {
                    showFinalResult(remaining, radix, stepHtml, previousHtml + currentHtml, stepsDiv, visualDiv, resultDiv);
                }, 1500);
            }
        }

        function showFinalResult(decimal, radix, stepHtml, previousHtml, stepsDiv, visualDiv, resultDiv) {
            stepHtml += '<div class="step-info">最終ステップ: 各サイズの箱の個数から' + radix + '進法を求める</div>';
            
            let tempDecimal = decimal;
            let digits = [];
            let digitInfo = [];
            let level = 0;
            
            while (tempDecimal > 0 || level === 0) {
                const digit = tempDecimal % radix;
                const digitChar = digit < 10 ? digit.toString() : String.fromCharCode(65 + digit - 10);
                digits.unshift(digitChar);
                
                digitInfo.unshift({
                    level: level,
                    digit: digit,
                    digitChar: digitChar,
                    boxSize: Math.pow(radix, level)
                });
                
                tempDecimal = Math.floor(tempDecimal / radix);
                level++;
                
                if (tempDecimal === 0) break;
            }
            
            const result = digits.join('');
            
            let calculationValues = [];
            for (let i = 0; i < digitInfo.length; i++) {
                const info = digitInfo[i];
                const value = info.digit * info.boxSize;
                calculationValues.push(value);
            }
            
            let finalResultHtml = '<div style="margin: 15px 0; padding: 15px; background-color: #f9f9f9; border: 2px solid #333;">';
            finalResultHtml += '<strong>各桁の値と合計:</strong><br><br>';
            
            finalResultHtml += '<div style="text-align: center; margin: 20px 0; font-size: 18px; font-weight: bold;">';
            finalResultHtml += calculationValues.join(' + ') + ' = ' + decimal;
            finalResultHtml += '</div>';
            
            finalResultHtml += '<table style="margin: 20px auto; border-collapse: collapse; font-size: 14px;">';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; font-size: 12px;"></td>';
            for (let i = 0; i < digitInfo.length; i++) {
                const info = digitInfo[i];
                const sizeLabel = info.level === 0 ? '1' : (radix + '×').repeat(info.level) + '1';
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; background-color: #f0f0f0; font-size: 12px;">' + sizeLabel + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #e8f5e8; font-weight: bold; text-align: center;">箱</td>';
            for (let i = 0; i < digitInfo.length; i++) {
                const info = digitInfo[i];
                if (info.level === 0) {
                    finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; border: 2px dotted #999;">箱なし</td>';
                } else {
                    const levelName = 'サイズ' + info.boxSize;
                    finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; background-color: #e1f5fe;">' + levelName + '</td>';
                }
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #e8f5e8; font-weight: bold; text-align: center;">個数</td>';
            for (let i = 0; i < digitInfo.length; i++) {
                const info = digitInfo[i];
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; font-weight: bold;">' + info.digit + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '</table>';
            
            finalResultHtml += '<div style="text-align: center; margin-top: 20px; font-size: 18px;"><strong>したがって: ' + decimal + '(10) = ' + result + '(' + radix + ')</strong></div>';
            finalResultHtml += '</div>';
            
            stepsDiv.innerHTML = stepHtml;
            visualDiv.innerHTML = previousHtml + finalResultHtml;
            resultDiv.innerHTML = '<div class="result">' + decimal + '(10) = ' + result + '(' + radix + ')</div>';
            
            setTimeout(() => {
                const radixInput = document.getElementById('radixInput');
                if (radixInput) {
                    radixInput.value = result;
                }
            }, 100);
        }

        function visualizeRadixToDecimal(radixStr, radix) {
            const stepsDiv = document.getElementById('radix-to-decimal-steps');
            const visualDiv = document.getElementById('radix-to-decimal-visualization');
            const resultDiv = document.getElementById('radix-to-decimal-result');
            
            stepsDiv.innerHTML = '';
            visualDiv.innerHTML = '';
            
            const digits = radixStr.split('');
            const length = digits.length;
            let total = 0;
            
            let digitValues = [];
            for (let i = 0; i < length; i++) {
                const digit = parseInt(digits[i], radix);
                const power = length - 1 - i;
                const position = Math.pow(radix, power);
                const value = digit * position;
                total += value;
                digitValues.push({
                    digit: digit,
                    power: power,
                    position: position,
                    value: value,
                    digitChar: digits[i]
                });
            }
            
            let stepHtml = '<div class="step-info">ステップ1: ' + radixStr + '(' + radix + ')の各桁を分析</div>';
            stepHtml += '<div class="step-info">ステップ2: 各桁の位置価値を計算</div>';
            stepHtml += '<div class="step-info">ステップ3: 各桁の値と合計を計算</div>';
            
            let finalResultHtml = '<div style="margin: 15px 0; padding: 15px; background-color: #f9f9f9; border: 2px solid #333;">';
            finalResultHtml += '<strong>各桁の値と合計:</strong><br><br>';
            
            finalResultHtml += '<div style="text-align: center; margin: 20px 0; font-size: 18px; font-weight: bold;">';
            finalResultHtml += digitValues.map(d => d.value).join(' + ') + ' = ' + total;
            finalResultHtml += '</div>';
            
            finalResultHtml += '<table style="margin: 20px auto; border-collapse: collapse; font-size: 14px;">';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #f0f0f0; font-size: 12px;"></td>';
            for (let i = 0; i < digitValues.length; i++) {
                const info = digitValues[i];
                const positionLabel = info.power === 0 ? '1' : (radix + '×').repeat(info.power) + '1';
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; background-color: #f0f0f0; font-size: 12px;">' + positionLabel + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #e8f5e8; font-weight: bold; text-align: center;">位置価値</td>';
            for (let i = 0; i < digitValues.length; i++) {
                const info = digitValues[i];
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; background-color: #e1f5fe;">' + info.position + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #e8f5e8; font-weight: bold; text-align: center;">N進法の桁</td>';
            for (let i = 0; i < digitValues.length; i++) {
                const info = digitValues[i];
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; font-weight: bold;">' + info.digitChar + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '<tr>';
            finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px; background-color: #e8f5e8; font-weight: bold; text-align: center;">各桁の値</td>';
            for (let i = 0; i < digitValues.length; i++) {
                const info = digitValues[i];
                finalResultHtml += '<td style="border: 1px solid #ccc; padding: 8px 15px; text-align: center; font-weight: bold; color: #d32f2f;">' + info.value + '</td>';
            }
            finalResultHtml += '</tr>';
            
            finalResultHtml += '</table>';
            
            finalResultHtml += '<div style="text-align: center; margin-top: 20px; font-size: 18px;"><strong>したがって: ' + radixStr + '(' + radix + ') = ' + total + '(10)</strong></div>';
            finalResultHtml += '</div>';
            
            stepsDiv.innerHTML = stepHtml;
            visualDiv.innerHTML = finalResultHtml;
            resultDiv.innerHTML = '<div class="result">' + radixStr + '(' + radix + ') = ' + total + '(10)</div>';
            
            setTimeout(() => {
                const decimalInput = document.getElementById('decimalInput');
                if (decimalInput) {
                    decimalInput.value = total;
                }
            }, 100);
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.innerHTML = '<div class="result error">' + message + '</div>';
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            if (tabId === 'decimal-to-radix') {
                document.getElementById('decimal-to-radix-steps').innerHTML = '';
                document.getElementById('decimal-to-radix-visualization').innerHTML = '';
                document.getElementById('decimal-to-radix-result').innerHTML = '';
            } else if (tabId === 'radix-to-decimal') {
                document.getElementById('radix-to-decimal-steps').innerHTML = '';
                document.getElementById('radix-to-decimal-visualization').innerHTML = '';
                document.getElementById('radix-to-decimal-result').innerHTML = '';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            convertDecimalToRadix();
        });

        document.getElementById('decimalInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') convertDecimalToRadix();
        });

        document.getElementById('radixInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') convertRadixToDecimal();
        });

        document.getElementById('radix').addEventListener('change', function() {
            const activeTab = document.querySelector('.tab-content.active').id;
            if (activeTab === 'decimal-to-radix' && document.getElementById('decimalInput').value) {
                convertDecimalToRadix();
            } else if (activeTab === 'radix-to-decimal' && document.getElementById('radixInput').value) {
                convertRadixToDecimal();
            }
        });
    </script>
</body>
</html>
